# VPC_ネットワーク構築手順

* VPC：Virtual Private Cloud
* 下記構成のVPCネットワークを作成する

### VPC

* リージョン：東京
* CIDR ブロック：10.0.0.0/16

### サブネット

#### パブリックサブネット

* Webサーバーを配置する
* CIDR ブロック：10.0.10.0/24

#### プライベートサブネット

* データベースサーバーを配置する
* CIDR ブロック：10.0.20.0/24

### アベイラビリティゾーン

* 上記のサブネットを同一のアベイラビリティゾーンに設定する
* アベイラビリティゾーンを分けるのはサーバーの冗長化を検討する段階になったらでよい

***

## １．VPCを作成する

* AWS上に仮想ネットワークを作成する
* ルーターやハブの準備に相当

### リージョンを選択する

* 上部メニューからプルダウンで __アジアパシフィック(東京)__ のリージョンを選択する

***

### VPCを作成する

* VPCをネットワーク単位で分割して利用しやすくする

1. __VPC__ のダッシュボードを開く
2. メニューから __VPC__ をクリックする
3. __VPCを作成__ をクリックする
4. 以下の入力と設定をして __作成__ をクリックする
    * 名前タグ：magenta-magenta-vpc
    * IPv4 CIDR ブロック：10.0.0.0/16
    * IPv6 CIDR ブロック：IPv6 CIDR ブロックなし
    * テナンシー：デフォルト
        * 物理ハードウェアを専有するオプション、EC2の料金が割高になる、ここでは不要
5. 完了画面が表示されるので __閉じる__ をクリックする
     * 作成されたVPCが一覧に表示される

***

## ２．サブネットを作成する

* VPCを分割して利便性を高める
    * アベイラビリティゾーンを分けることで耐障害性を高める
    * ネットワークをパブリックとプライベートに分けることでセキュリティを高める
    * 業務目的に応じてネットワークごとのセキュリティレベルを設定する

### パブリックサブネット

1. メニューから __サブネット__ をクリックする
    * サブネットの一覧が表示される
2. __サブネットを作成__ をクリックする
3. 以下の入力と設定をして __サブネットを作成__ をクリックする
    * VPC ID：magenta-magenta-vpc
    * サブネット名：magenta-magenta-public-subnet-1a
    * アベイラビリティゾーン：ap-northeast-1a
    * IPv4 CIDR ブロック：10.0.10.0/24

### プライベートサブネット

1. 続けて __サブネットを作成__ をクリックする
2. 以下の入力と設定をして __サブネットを作成__ をクリックする
    * VPC ID：magenta-magenta-vpc
    * サブネット名：magenta-magenta-private-subnet-1a
    * アベイラビリティゾーン：ap-northeast-1a
    * IPv4 CIDR ブロック：10.0.20.0/24

***

## ３．ルーティングを設定する

* インターネット回線を引く作業に相当
* ルートテーブルにインターネットゲートウェイ向けのターゲットを設定する
* サブネットからインターネットに接続できるようにする

### インターネットゲートウェイを作成する

1. メニューから __インターネットゲートウェイ__ をクリックする
2. __インターネットゲートウェイの作成__ をクリックする
3. 名前タグ（__magenta-magenta-igw__）を入力して __インターネットゲートウェイの作成__ をクリックする

### VPCにアタッチする

1. 一覧から作成したインターネットゲートウェイを選択して __アクション__ メニューから __VPCにアタッチ__ を選択する
2. 作成済みのVPC（__magenta-magenta-vpc__）を選択して __インターネットゲートウェイのアタッチ__ をクリックする

### ルートテーブルを作成する

1. メニューから __ルートテーブル__ をクリックする
2. __ルートテーブルの作成__ をクリックする
3. 以下の入力と設定をして __作成__ をクリックする
    * 名前タグ：magenta-magenta-public-route
    * VPC：magenta-magenta-vpc
4. 一覧に戻って作成したルートテーブルを選択して __サブネットの関連付け__ タブの __サブネットの関連付けの編集__ をクリックする
5. パブリックサブネット（__magenta-magenta-public-subnet-1a__）を選択して __保存__ をクリックする

### デフォルトルートをインターネットゲートウェイに設定する

1. 一覧から作成したルートテーブルを選択して __ルート__ タブの __ルートの編集__ をクリックする
2. __ルートの追加__ をクリックし、以下の入力と設定をして __ルートの保存__ をクリックする
    * 送信先：0.0.0.0/0
    * ターゲット：Internet Gateway → magenta-magenta-igw

* この時点で作成されているルートテーブル

  |送信先|ターゲット|意味|
  |--|--|--|
  |1.0.0.0/16|local|同VPC領域内の通信は内部でルーティング|
  |0.0.0.0/0|igw-*****|それ以外はインターネットゲートウェイに転送|

## VPC設計ポイント

### IPアドレス

* プライベートIPアドレスの使用を推奨
* 作成後の変更ができないためレンジを大きめに取る（/16推奨）
* 他システムとの重複に注意

### プライベートIPアドレス

|プライベートIPアドレス範囲|
|--|
|10.0.0.0 - 10.255.255.255|
|172.16.0.0 - 172.31.255.255|
|192.168.0.0 - 192.168.255.255|

### アカウントの使い分け

#### システムが異なる場合

* システムごとにアカウントを分ける

#### 同一システムで環境が異なる（本番・ステージング・開発）場合

1. アカウントは同一でVPCとリージョンを分ける
   * ○：IAMの設定が一度で済む
   * ✕：別環境のリソースが見えるため事故につながる
2. アカウントを分ける
   * ✕：IAMの設定が環境ごとに必要になる
   * ○：別環境のリソースが見えないので事故を防げる

### サブネット

#### IPアドレス

* 将来的に枯渇しないIPアドレス範囲を見積もる（/24が一般的）

#### 分割ポリシー

* サブネットに割り当てられるルートテーブルは1つだけ
* ルーティングとアベイラビリティゾーンを基準にする

#### ルーティングポリシー

* インターネットアクセスの有無
* 拠点アクセスの有無

#### アベイラビリティゾーンポリシー

* 高可用性、耐障害性のためにアベイラビリティゾーンを分けて冗長化するためにサブネットを分割する