# 決定木モデルの作成

ここでは[SIGNATEの練習問題データ](https://signate.jp/competitions/1/data)を使用している

## 決定木モデルの概要
* 質問に対する分岐を階層的に作ることで、判別／回帰を行うモデル
* パラメータ調整を適切にしないと過学習しやすい
* このケースでは顧客が銀行口座を開設するかしないかの __分類__ を予測し、評価尺度は __AUC__ （1が最も良い）を用いる


## データの準備
* Graphvizのインストール
  ```bash
  !pip install graphviz pydotplus
  ```

* ライブラリのインポート
* __DecisionTreeClassifier__ は決定木用のライブラリ
  ```python
  import pandas as pd
  import numpy as np
  from matplotlib import pyplot as plt
  %matplotlib inline

  from sklearn.tree import DecisionTreeClassifier as DT
  from sklearn.tree import export_graphviz
  import pydotplus
  from IPython.display import Image
  ```

* CSVデータの読み込み
  ```python
  train = pd.read_csv("train.csv")
  test = pd.read_csv("test.csv")
  sample = pd.read_csv("submit_sample.csv",header=None)
  ```

* 学習データと評価データの先頭行を確認する
  ```python
  train.head()
  test.head()
  ```

## 説明変数と目的変数の設定
* 学習データの説明変数を抽出する
* 目的変数y以外のカラムを説明変数に設定する
  ```python
  # 全ての行、最初から17列目までを指定
  trainX = train.iloc[:,0:17]

  # 内容を確認
  trainX.head()
  ```

* 学習データの目的変数を抽出する
  ```python
  y = train["y"]
  ```

* 評価データの説明変数を抽出する
* 全カラムを説明変数に設定する
  ```python
  testX = test.copy()
  ```

* 質的データをダミー変数化する
  ```python
  trainX = pd.get_dummies(trainX)
  testX = pd.get_dummies(testX)
  ```

## モデルの準備
* モデルを表す変数を用意する
  ```python
  clf = DT(max_depth=2,min_samples_leaf=500)
  ```

## モデルの作成
* fit関数（説明変数、目的変数の順に指定）でモデルを作成する
  ```python
  clf.fit(trainX,y)
  ```

## 決定木を可視化する
* 決定木の図のデータをdotファイルで書き出す
  ```python
  export_graphviz(clf, out_file="tree.dot", feature_names=trainX.columns, class_names=["0","1"], filled=True, rounded=True)
  ```

* 書き出したデータを表示する
  ```python
  g = pydotplus.graph_from_dot_file(path="tree.dot")
  Image(g.create_png())
  ```

* predict関数を使った予測結果を変数に代入する
* 変数を表示するとそれぞれの行に __[ 0である確率、1である確率 ]__ が含まれている事がわかる
  ```python
  pred = clf.predict_proba(testX)
  pred
  ```

* 1である確率のみを抜き出して変数に代入する
* 行は全て、列は配列[1]を指定する
  ```python
  pred = pred[:,1]
  pred
  ```

## モデルの評価
* SIGNATEで評価する形式にデータを加工する
* sampleファイルのカラム[1]に、予測結果を代入する
  ```python
  sample.head()

  sample[1] = pred
  ```

* sampleをCSVファイルに書き出す
  ```python
  sample.to_csv("submit1_bank.csv",index=None,header=None)
  ```

* 書き出したファイルを[SIGNATE](https://signate.jp/competitions/24/data)に投稿して評価を確認する
