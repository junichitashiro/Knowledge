# ブックに対する処理

---

## ブックのオープン

### 処理

1. 同じフォルダにあるbook1.xlsxを開く
2. 開く前に以下のチェックをする
    1. ファイルが存在するか
    2. すでに開いていないか
3. 開いたブックをアクティブにしない

```vb
Option Explicit

Public Sub OpenBookWithoutActivating()
    Const TARGET_FILE As String = "book1.xlsx"

    Dim folderPath As String
    Dim fullPath As String
    Dim openedWb As Workbook
    Dim prevActiveWb As Workbook

    folderPath = ThisWorkbook.Path
    fullPath = folderPath & Application.PathSeparator & TARGET_FILE

    ' 1) ファイル存在チェック
    If Len(Dir$(fullPath, vbNormal)) = 0 Then
        MsgBox "ファイルが存在しません: " & fullPath, vbExclamation
        Exit Sub
    End If

    ' 2) 既に開いていないか（フルパスで判定）
    If IsWorkbookOpenByFullPath(fullPath) Then
        MsgBox "すでに開いています: " & TARGET_FILE, vbInformation
        Exit Sub
    End If

    On Error GoTo CleanFail

    Set prevActiveWb = ActiveWorkbook ' Excel起動直後などでは Nothing の場合あり

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False

    ' 3) ブックを開く
    '   必要に応じて以下のオプションを指定可能
    '     ReadOnly:=True        ' 読み取り専用で開く（編集させたくない場合）
    '     Notify:=False         ' 読み取り専用解除通知を行わない
    '     AddToMru:=False       ' 最近使用したファイル（MRU）に追加しない
    '     UpdateLinks:=False   ' 外部リンクを更新しない（既定で指定）
    Set openedWb = Workbooks.Open( _
        Filename:=fullPath, _
        UpdateLinks:=False _
    )

    ' 4) 元のブックを再アクティブ化（＝開いたブックを前面に出さない）
    If Not prevActiveWb Is Nothing Then
        prevActiveWb.Activate
    Else
        ThisWorkbook.Activate
    End If

CleanExit:
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Exit Sub

CleanFail:
    MsgBox "エラー: " & Err.Number & vbCrLf & Err.Description, vbCritical
    Resume CleanExit
End Sub

Private Function IsWorkbookOpenByFullPath(ByVal fullPath As String) As Boolean
    Dim wb As Workbook

    For Each wb In Application.Workbooks
        ' FullName（フルパス）で比較する方が安全
        If StrComp(wb.FullName, fullPath, vbTextCompare) = 0 Then
            IsWorkbookOpenByFullPath = True
            Exit Function
        End If
    Next wb
End Function
```

---

## ブックの読み取り専用オープンとクローズ

### 処理

1. 同じディレクトリにあるファイル 参照先.xlsx を読み取り専用で開く
2. そのまま閉じる

```vb
Option Explicit

Public Sub ReadOnlyOpenAndClose()
    Const TARGET_FILE As String = "参照先.xlsx"

    Dim fullPath As String
    Dim wbOpened As Workbook
    Dim prevActiveWb As Workbook

    fullPath = ThisWorkbook.Path & Application.PathSeparator & TARGET_FILE

    ' ファイル存在チェック（任意だが実務では推奨）
    If Len(Dir$(fullPath, vbNormal)) = 0 Then
        MsgBox "ファイルが存在しません: " & fullPath, vbExclamation
        Exit Sub
    End If

    On Error GoTo CleanFail

    Set prevActiveWb = ActiveWorkbook

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False

    ' 読み取り専用で開く → すぐ閉じる
    ' 必要なら AddToMru:=False / Notify:=False なども追加可能
    Set wbOpened = Workbooks.Open( _
        Filename:=fullPath, _
        ReadOnly:=True, _
        UpdateLinks:=False, _
        AddToMru:=False _
    )

    wbOpened.Close SaveChanges:=False

    ' 画面上のアクティブを戻す（要件に無ければ削ってもOK）
    If Not prevActiveWb Is Nothing Then
        prevActiveWb.Activate
    Else
        ThisWorkbook.Activate
    End If

CleanExit:
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Exit Sub

CleanFail:
    MsgBox "エラー: " & Err.Number & vbCrLf & Err.Description, vbCritical
    Resume CleanExit
End Sub
```
