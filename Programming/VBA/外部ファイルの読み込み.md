# 外部ファイルの読み込み

---

## ファイルの存在チェック

### カレントディレクトリに読み込み対象のファイル(input.txt)があるか確認する

```vb
Option Explicit

Public Sub ExistCheck()
    Dim fullPath As String
    fullPath = ThisWorkbook.Path & Application.PathSeparator & "input.txt"

    If Len(Dir$(fullPath, vbNormal)) > 0 Then
        MsgBox "ファイルが存在します"
    Else
        MsgBox "ファイルが存在しません"
    End If
End Sub
```

### カレントディレクトリに input*.txt が存在するか確認する

```vb
Option Explicit

Public Sub ExistInputTxtCheck()
    Dim patternPath As String
    patternPath = ThisWorkbook.Path & Application.PathSeparator & "input*.txt"

    If Len(Dir$(patternPath, vbNormal)) > 0 Then
        MsgBox "input で始まる txt ファイルが存在します"
    Else
        MsgBox "input で始まる txt ファイルは存在しません"
    End If
End Sub
```


---

## ファイルの読み込みと転記

### テキストファイルを1行ずつ読み込んで転記する

```vb
Option Explicit

Public Sub ReadText()
    Dim fullPath As String
    Dim buf As String
    Dim i As Long
    Dim ws As Worksheet

    fullPath = ThisWorkbook.Path & Application.PathSeparator & "input.txt"
    Set ws = ThisWorkbook.Worksheets("Sheet1")

    Open fullPath For Input As #1
        Do Until EOF(1)
            Line Input #1, buf
            i = i + 1
            ws.Cells(i, 1).Value = buf
        Loop
    Close #1
End Sub
```

### CSVファイルを読み込んで転記する

```vb
Option Explicit

Public Sub ReadCsv()
    Dim fullPath As String
    Dim buf As String
    Dim i As Long
    Dim parts As Variant
    Dim ws As Worksheet

    fullPath = ThisWorkbook.Path & Application.PathSeparator & "input.csv"
    Set ws = ThisWorkbook.Worksheets("Sheet1")

    Open fullPath For Input As #1
        i = 1
        Do Until EOF(1)
            Line Input #1, buf
            parts = Split(buf, ",")

            ws.Cells(i, 1).Value = parts(0)
            ws.Cells(i, 2).Value = parts(1)
            ws.Cells(i, 3).Value = parts(2)

            i = i + 1
        Loop
    Close #1
End Sub
```

### input.csv の中身

```csv
A1,B1,C1
A2,B2,C2
A3,B3,C3
A4,B4,C4
A5,B5,C5
```

### 転記結果のイメージ

| A   | B   | C   |
| --- | --- | --- |
| A1  | B1  | C1  |
| A2  | B2  | C2  |
| A3  | B3  | C3  |
| A4  | B4  | C4  |
| A5  | B5  | C5  |

---

### "input" で始まる .txt を読み込み、Sheet1 に転記する

```vb
Option Explicit

Public Sub ReadInputTxtToSheet()
    Dim folderPath As String
    Dim fileName As String
    Dim fullPath As String
    Dim buf As String
    Dim i As Long
    Dim ws As Worksheet

    folderPath = ThisWorkbook.Path & Application.PathSeparator
    Set ws = ThisWorkbook.Worksheets("Sheet1")

    ' input で始まる txt ファイルを検索
    fileName = Dir$(folderPath & "input*.txt", vbNormal)

    If fileName = "" Then
        MsgBox "input で始まる txt ファイルは存在しません"
        Exit Sub
    End If

    fullPath = folderPath & fileName

    Open fullPath For Input As #1
        i = 1
        Do Until EOF(1)
            Line Input #1, buf
            ws.Cells(i, 1).Value = buf
            i = i + 1
        Loop
    Close #1
End Sub
```

---

## 外部ファイルの読み込み時チェック

### 読み込んだ外部ファイルの文字列を行単位でチェックする

#### 処理

* 条件に合致したらメッセージボックスに表示する
* 条件1：hoge を含む（InStr）
* 条件2：3文字目から4文字が hoge（Mid$）

```vb
Option Explicit

Public Sub ReadTextCheck()
    Dim fullPath As String
    Dim buf As String

    fullPath = ThisWorkbook.Path & Application.PathSeparator & "input.txt"

    Open fullPath For Input As #1
        Do Until EOF(1)
            Line Input #1, buf

            If InStr(1, buf, "hoge", vbBinaryCompare) > 0 Then
                MsgBox buf
            End If

            If Mid$(buf, 3, 4) = "hoge" Then
                MsgBox buf
            End If
        Loop
    Close #1
End Sub
```

---

### 読み込んだ外部ファイルの特定の範囲のみを処理対象にする

* **start** 行から **end** 行を表示する

```vb
Option Explicit

Public Sub ReadingRange()
    Dim fullPath As String
    Dim buf As String
    Dim inRange As Boolean

    fullPath = ThisWorkbook.Path & Application.PathSeparator & "input.txt"

    Open fullPath For Input As #1
        Do Until EOF(1)
            Line Input #1, buf

            If InStr(1, buf, "start", vbBinaryCompare) > 0 Then
                inRange = True
                MsgBox "読み込み開始"
                GoTo ContinueLoop
            End If

            If InStr(1, buf, "end", vbBinaryCompare) > 0 Then
                inRange = False
                MsgBox "読み込み終了"
                Exit Do
            End If

            If inRange Then
                MsgBox buf
            End If

ContinueLoop:
        Loop
    Close #1
End Sub
```

### input.txt の中身

```txt
111
222
333
start
444
555
666
end
777
888
999
```

### 実行結果

> 読み込み開始  
  444  
  555  
  666  
  読み込み終了
